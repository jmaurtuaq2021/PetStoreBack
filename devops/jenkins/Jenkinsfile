@Library('jenkins-library@master')_

pipeline {
    agent {
        label 'agent-1'
    }
    environment {
        CHANNEL_NOTIFY  = "qa-automation"
        AZ_USER         = credentials('az-user')
        AZ_PASSWORD     = credentials('az-password')
        AZ_SUBSCRIPTION = "bd3b762b-188e-4a66-a9d3-eb9aff4d8749"

    }
    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['integration', 'certification', 'production'],
            description: 'Select environment.'
        )
        string(name: 'OPTIONS', defaultValue: '', description: 'Set cucumber options. Ej: --tags @TagDevopsTest1')
    }
    stages {
        stage("Test") {
            steps {
                script {
                    notification(type:'started', env:CHANNEL_NOTIFY)
                    //wrap([$class: 'Xvfb', screen: '1920x1080x24']) {
                        cucumberTest(environment: ENVIRONMENT, options: OPTIONS)
                    //}
                }
            }
        }
    }
    post {
        success {
            script {
                def reportPath  = "target/site/cucumber-reports/cucumber-html-reports/"
                def reportUrl   = null

                    reportUrl = deployStatic.azure(
                        username: AZ_USER,
                        password: AZ_PASSWORD,
                        storage: "pacificodevops",
                        source: reportPath,
                        destination: "jenkins/${JOB_NAME}/${BUILD_NUMBER}/cucumber/r1",
                        linkText: "Cucumber Report",
                        linkIndex: "overview-features.html",
                        subscription: AZ_SUBSCRIPTION
                    )
                notification(type:'success', env:CHANNEL_NOTIFY, details: " [Cucumber report](${reportUrl})")
            }
        }
        failure {
           notification(type:'failure', env:CHANNEL_NOTIFY)
        }
        cleanup {
            cleanWs()
        }
    }
}
